@model DoAn4_ClassOnline.Models.KhoaHoc

@functions {
    string TimeAgo(DateTime date)
    {
        var ts = DateTime.Now - date;

        if (ts.TotalMinutes < 1) return "Vừa xong";
        if (ts.TotalHours < 1) return $"{(int)ts.TotalMinutes} phút trước";
        if (ts.TotalDays < 1) return $"{(int)ts.TotalHours} giờ trước";
        if (ts.TotalDays < 7) return $"{(int)ts.TotalDays} ngày trước";

        return $"{(int)ts.TotalDays} ngày trước";
    }
}

<div class="container">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a class="btn border-0" asp-controller="QuanLyKhoaHoc" asp-action="Index">
            <i class="bi bi-chevron-left"></i> Quay lại
        </a>

        <div class="text-center flex-grow-1">
            <h3 class="fw-bold mb-0">@Model.TenKhoaHoc</h3>
        </div>

        <div style="width:108px;"></div>
    </div>

    <div class="row g-3">

        <!-- LEFT: THÔNG TIN KHÓA HỌC -->
        <div class="col-md-4">
            <div class="p-3 rounded-4 shadow bg-white h-100">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-journal-bookmark text-primary me-2"></i> Thông tin khóa học
                </h6>

                <form class="row g-3">

                    <div class="col-12">
                        <label class="fw-semibold">Tên khóa học</label>
                        <input type="text" id="tenKhoaHoc_ChiTietQuanLy" class="form-control" value="@Model.TenKhoaHoc">
                        <small id="err_tenKhoaHoc_ChiTietQuanLy" class="text-danger d-none"></small>
                    </div>

                    <div class="col-12">
                        <label class="fw-semibold">Khoa</label>
                        <select id="khoaId_ChiTietQuanLy" class="form-select">
                            <option selected disabled value="@Model.Khoa.KhoaId">@Model.Khoa.TenKhoa</option>
                            @foreach (var hk in ViewBag.KhoaList)
                            {
                                <option value="@hk.KhoaId">
                                    @hk.TenKhoa
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="fw-semibold">Học kỳ</label>
                        <select id="hocKyId_ChiTietQuanLy" class="form-select">
                            <option selected disabled value="@Model.HocKyId">@Model.HocKy.TenHocKy / @Model.HocKy.NamHoc</option>
                            @foreach (var hk in ViewBag.HocKyList)
                            {
                                <option value="@hk.HocKyId">
                                    @hk.Ten
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="fw-semibold">Link google meet</label>
                        <div class="input-group">
                            <input type="text" id="googleMeetLink_ChiTietQuanLy" class="form-control" value="@(Model.LinkHocOnline ?? "")" />
                            <button class="btn btn-outline-primary" type="button" id="copyLinkBtn" title="Copy link">
                                <i class="bi bi-clipboard" id="copyLinkIcon"></i>
                            </button>                          
                        </div>
                        <small id="err_googleMeetLink_ChiTietQuanLy" class="text-danger d-none"></small>
                    </div>

                    <div class="col-12">
                        <label class="fw-semibold">Mật khẩu truy cập (không bắt buộc)</label>
                        <div class="input-group">
                            <input type="password" id="passwordInput_ChiTietQuanLy" class="form-control" value="@(Model.MatKhau ?? "")">                        
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword" title="Hiện/Ẩn mật khẩu">
                                <i class="bi bi-eye" id="togglePasswordIcon"></i>
                            </button>
                        </div>
                        <small id="err_passwordInput_ChiTietQuanLy" class="text-danger d-none"></small>
                    </div>

                    <div class="col-12">
                        <label class="fw-semibold">Hình ảnh khóa học</label>
                        <input type="file" id="anhKhoaHoc_ChiTietQuanLy" accept="image/*" class="form-control">
                    </div>

                    <div class="col-12">
                        <div class="border rounded-4 p-2 text-center" style="max-height:200px; overflow:hidden;">
                            <img src="@Model.HinhAnh"
                                 class="rounded-3"
                                 style="max-width:100%; height:150px; object-fit:cover;">
                        </div>
                    </div>

                    <div class="col-12 d-flex justify-content-between mt-3">
                        @if (Model.TrangThaiKhoaHoc == "DangKhoa")
                        {
                            <button type="button" class="btn btn-primary rounded-3"
                                    id="btn-khoa-@Model.KhoaHocId"
                                    onclick="moKhoaKhoaHoc(@Model.KhoaHocId)">
                                Mở khóa học
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-danger rounded-3"
                                    id="btn-khoa-@Model.KhoaHocId"
                                    onclick="khoaKhoaHoc(@Model.KhoaHocId)">
                                Khóa khóa học
                            </button>
                        }
                        <button type="reset" class="btn btn-secondary rounded-3 text-light" onclick="clearErrors_Update()">Đặt lại</button>
                        <button type="button" onclick="capNhatKhoaHoc_QuanLy(@Model.KhoaHocId)" class="btn btn-success rounded-3">Lưu thay đổi</button>
                    </div>

                </form>
            </div>
        </div>

        <!-- RIGHT: DANH SÁCH SINH VIÊN -->
        <div class="col-md-8">
            <div class="p-4 shadow rounded-4 bg-white h-100 d-flex flex-column">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-people text-primary me-2"></i> Danh sách sinh viên
                    </h5>

                    <div class="d-flex gap-2">

                        <!-- ✅ ICON TÌM KIẾM TRONG INPUT -->
                        <div class="input-group input-group-sm" style="width:260px;">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input class="form-control" placeholder="Tìm theo tên hoặc mã...">
                        </div>

                        <!-- ✅ ĐÚNG -->
                        <button class="btn btn-outline-success btn-sm" onclick="xuatDanhSachSinhVien(@Model.KhoaHocId)">
                            <i class="bi bi-download"></i> Xuất file
                        </button>

                    </div>
                </div>

                <div class="table-responsive" style="max-height:580px; overflow:auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light" style="position:sticky; top:0; z-index:10;">
                            <tr>
                                <th style="width:60px;">STT</th>
                                <th>Sinh viên</th>                           
                                <th style="width:120px;">MSSV</th>
                                <th style="width:120px;">Giới tính</th>
                                <th style="width:120px;">Truy cập</th>
                                <th style="width:120px;">Hành động</th>
                            </tr>
                        </thead>

                        <tbody>
                            @{
                                var lichSuDict = ViewBag.LichSuTruyCap as Dictionary<int, DateTime?>;
                                int stt = 1;
                            }
                            @foreach (var item in Model.ThamGiaKhoaHocs)
                            {
                                var thoiGianTruyCap = lichSuDict != null && lichSuDict.ContainsKey(item.SinhVienId)
                                ? lichSuDict[item.SinhVienId]
                                : null;
                                <tr>
                                    <td>@stt</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="@item.SinhVien.Avatar"
                                                 class="rounded-circle me-3"
                                                 style="width:45px; height:45px; object-fit:cover;">
                                            <div class="fw-semibold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">@item.SinhVien.FullName</div>
                                        </div>
                                    </td>
                                    <td class="fw-semibold">@item.SinhVien.MaSo</td>
                                    <td class="fw-semibold">@item.SinhVien.GioiTinh</td>
                                    <td>
                                        @if (thoiGianTruyCap.HasValue)
                                        {
                                            <small class="text-muted">
                                                @TimeAgo(thoiGianTruyCap.Value)
                                            </small>
                                        }
                                        else
                                        {
                                            <small class="text-muted fst-italic">Chưa truy cập</small>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-secondary btn-sm" title="Xem hồ sơ"
                                               onclick="xemHoSoSinhVien(@item.SinhVienId)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                stt++; 
                            }
                            
                        </tbody>

                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL -->
<div class="modal fade" id="studentInfoModal_QuanLy" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">

            <div class="modal-header">
                <h5 class="modal-title">Thông tin sinh viên</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-4">
                <div class="row g-3">

                    <div class="col-md-4 text-center">
                        <img id="modal_avatar" src="~/assets/image/tải xuống.jpg"
                             class="rounded-circle border shadow-sm mb-3"
                             style="width:140px;height:140px;object-fit:cover;">

                        <h5 id="modal_fullname" class="fw-bold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">Nguyễn Văn A</h5>
                        <small id="modal_maso" class="text-muted d-block">CNTT2211026</small>
                    </div>

                    <div class="col-md-8">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Giới tính</dt>
                            <dd id="modal_gioitinh" class="col-sm-8">Nam</dd>

                            <dt class="col-sm-4">Ngày sinh</dt>
                            <dd id="modal_ngaysinh" class="col-sm-8">01/01/2003</dd>

                            <dt class="col-sm-4">Email</dt>
                            <dd id="modal_email" class="col-sm-8">vana@example.com</dd>

                            <dt class="col-sm-4">Số điện thoại</dt>
                            <dd id="modal_phone" class="col-sm-8">0123 456 789</dd>

                            <dt class="col-sm-4">Khoa</dt>
                            <dd id="modal_khoa" class="col-sm-8">Công nghệ thông tin</dd>
                        </dl>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script src="~/assets/js/teacher/chitietkhoahoc_quanly.js"></script>


