@model DoAn4_ClassOnline.Models.BaiTracNghiem

@{
    ViewData["Title"] = Model != null ? Model.TenBaiThi : "Chi tiết bài trắc nghiệm";
    var soLuotLam = Model?.BaiLamTracNghiems?.Count ?? 0;
    var soCauHoi = Model?.CauHois?.Count ?? 0;
}
    
<div class="container mt-3">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a class="btn border-0" href="javascript:history.back()">
            <i class="bi bi-chevron-left me-1"></i> Quay lại
        </a>

        <!-- ô trống cân đối -->
        <div style="width: 100px;"></div>
    </div>

    <div class="row g-3">
        <!-- LEFT SIDEBAR -->
        <div class="col-md-4">
            <div class="p-3 rounded-4 shadow bg-white">

                <!-- Thông tin bài thi -->
                <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-file-earmark-text fs-3 text-primary me-2"></i>
                    <div>
                        <strong>@(Model?.TenBaiThi ?? "Chưa có tên")</strong>
                        <div class="text-muted small">
                            Ngày tạo: @(Model?.NgayTao?.ToString("dd/MM/yyyy") ?? "N/A")
                        </div>
                        <div class="text-muted small">
                            Người tạo: @(Model?.KhoaHoc?.GiaoVien?.FullName ?? "N/A")
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-clipboard-check me-1"></i>
                            Số lượt làm: @soLuotLam
                        </div>
                    </div>
                </div>

                <!-- Nút Copy Link + QR -->
                <div class="d-flex justify-content-between mb-3">
                    <button class="btn btn-light border rounded-3" onclick="copyLink()">
                        <i class="bi bi-link-45deg"></i> Copy Link
                    </button>
                    <button class="btn btn-light border rounded-3" onclick="showQR()">
                        <i class="bi bi-qr-code"></i>
                    </button>
                </div>

                <!-- Menu -->
                <div class="border rounded-4 p-3 bg-body-tertiary">
                    <p class="text-muted fw-bold mb-3">Menu</p>

                    <div class="d-flex align-items-center mb-2" data-bs-toggle="modal" data-bs-target="#settingModal" style="cursor: pointer;">
                        <i class="bi bi-gear-wide-connected me-2"></i> Cài đặt
                    </div>
                    <div class="d-flex align-items-center text-danger" id="btnDeleteFile" style="cursor: pointer;" onclick="deleteBai(@Model?.BaiTracNghiemId)">
                        <i class="bi bi-file-earmark-x me-2"></i> Xóa bài thi
                    </div>
                </div>

                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Giao cho</span>
                        <!-- Nút Sửa -->
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal">
                            <i class="bi bi-pencil"></i> Sửa
                        </button>
                    </div>
                    <div class="border rounded-4 p-2 text-center bg-body-tertiary">
                        @if (Model?.GiaoBaiTracNghiems != null && Model.GiaoBaiTracNghiems.Any())
                        {
                            var soSinhVienDuocGiao = Model.GiaoBaiTracNghiems.Count(g => g.SinhVienId != null);
                            if (soSinhVienDuocGiao == 0)
                            {
                                <text>Tất cả mọi người</text>
                            }
                            else
                            {
                                <text>Giao cho @soSinhVienDuocGiao sinh viên</text>
                            }
                        }
                        else
                        {
                            <text>Chưa giao cho ai</text>
                        }
                    </div>
                </div>

                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Nội dung</span>
                        <div>
                            <a class="text-primary text-decoration-none small me-3" href="javascript:void(0)" onclick="editContent()">Sửa</a>
                            <!-- Nút Xem chi tiết -->
                            <a class="text-success text-decoration-none small" data-bs-toggle="modal" data-bs-target="#detailModal">
                                Xem chi tiết
                            </a>
                        </div>
                    </div>
                    <div class="border rounded-4 p-2 text-center bg-body-tertiary">
                        Trắc nghiệm @soCauHoi câu
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT CONTENT -->
        <div class="col-md-8">
            <div class="p-4 shadow rounded-4 bg-white">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        Kết quả làm bài trắc nghiệm
                    </h5>
                    <div>
                        <button class="btn btn-outline-success btn-sm" onclick="exportResults()">
                            <i class="bi bi-download me-1"></i> Xuất file
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshResults()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Cập nhật
                        </button>
                    </div>
                </div>

                <div class="table-responsive" style="max-height:507px; overflow-y:auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light" style="position:sticky; top:0; z-index:10;">
                            <tr>
                                <th style="width:60px;">STT</th>
                                <th>Sinh viên</th>
                                <th style="width:80px;">Điểm</th>
                                <th style="width:110px;">Số lần làm</th>
                                <th style="width:120px;">Ngày nộp</th>
                                <th style="width:130px;">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.BaiLamTracNghiems != null && Model.BaiLamTracNghiems.Any())
                            {
                                int stt = 1;
                                foreach (var baiLam in Model.BaiLamTracNghiems.OrderByDescending(b => b.NgayNop))
                                {
                                    var diem = baiLam.Diem ?? 0;
                                    var colorClass = diem >= 8 ? "text-success" : diem >= 5 ? "text-warning" : "text-danger";
                                    
                                    // ⭐ LOGIC: XÁC ĐỊNH TRẠNG THÁI
                                    string trangThai;
                                    string badgeClass;
                                    string iconClass;
                                    
                                    if (baiLam.NgayNop.HasValue)
                                    {
                                        trangThai = "Đã Nộp";
                                        badgeClass = "bg-success";
                                        iconClass = "bi-check-circle-fill";
                                    }
                                    else if (baiLam.NgayBatDau.HasValue)
                                    {
                                        trangThai = "Đang Làm";
                                        badgeClass = "bg-warning";
                                        iconClass = "bi-clock-fill";
                                    }
                                    else
                                    {
                                        trangThai = "Không Làm";
                                        badgeClass = "bg-secondary";
                                        iconClass = "bi-x-circle-fill";
                                    }
                                    
                                    <tr>
                                        <td class="fw-semibold">@stt</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@(baiLam.SinhVien?.Avatar ?? "/assets/image/tải xuống.jpg")" 
                                                     class="rounded-circle me-3" 
                                                     width="40" height="40" 
                                                     alt="avatar"
                                                     onerror="this.src='/assets/image/tải xuống.jpg'">
                                                <span class="fw-semibold">@(baiLam.SinhVien?.FullName ?? "N/A")</span>
                                            </div>
                                        </td>
                                        <td class="fw-bold @colorClass">
                                            @if (baiLam.NgayNop.HasValue)
                                            {
                                                @diem.ToString("F1")
                                            }
                                            else
                                            {
                                                <span class="text-muted">--</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            @(baiLam.SoLanLam ?? 0) lần
                                        </td>
                                        <td>
                                            @if (baiLam.NgayNop.HasValue)
                                            {
                                                @baiLam.NgayNop.Value.ToString("dd/MM/yyyy HH:mm")
                                            }
                                            else if (baiLam.NgayBatDau.HasValue)
                                            {
                                                <span class="text-muted">Đang làm...</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Chưa làm</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @badgeClass d-flex align-items-center justify-content-center gap-1" style="width: fit-content;">
                                                <i class="bi @iconClass"></i>
                                                @trangThai
                                            </span>
                                        </td>
                                    </tr>
                                    stt++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        Chưa có sinh viên nào làm bài
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

        <!-- Modal Cài Đặt -->
        <div class="modal fade" id="settingModal" tabindex="-1" aria-labelledby="settingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content rounded-4">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="settingModalLabel">
                            <i class="bi bi-gear-wide-connected me-2"></i> Cài đặt bài thi
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <form class="row g-3" id="formSettings">

                            <!-- Tên bài thi -->
                            <div class="col-12">
                                <label class="fw-semibold">Tên bài thi:</label>
                                <input type="text" class="form-control" id="tenBaiThi" placeholder="Nhập tên bài thi" value="@Model?.TenBaiThi">
                            </div>

                            <div class="col-12">
                                <label class="fw-semibold">Loại bài:</label>
                                <select class="form-select" id="loaiBai">
                                    <option value="Bài tập" selected="@(Model?.LoaiBaiThi == "Bài tập")">Bài tập</option>
                                    <option value="Bài thi" selected="@(Model?.LoaiBaiThi == "Bài thi")">Bài thi</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="fw-semibold">Thời gian làm bài (phút):</label>
                                <input type="number" class="form-control" id="thoiGianLamBai" placeholder="Số phút" value="@Model?.ThoiLuongLamBai" min="1">
                            </div>

                            <div class="col-md-6">
                                <label class="fw-semibold">Số lần làm tối đa:</label>
                                <input type="number" class="form-control" id="soLanLam" placeholder="0 = không giới hạn" value="@Model?.SoLanLamToiDa" min="0">
                            </div>

                            <div class="col-md-6">
                                <label class="fw-semibold">Thời gian bắt đầu:</label>
                                <input type="datetime-local" class="form-control" id="thoiGianBatDau" value="@(Model?.ThoiGianBatDau?.ToString("yyyy-MM-ddTHH:mm") ?? "")">
                            </div>

                            <div class="col-md-6">
                                <label class="fw-semibold">Thời gian kết thúc:</label>
                                <input type="datetime-local" class="form-control" id="thoiGianKetThuc" value="@(Model?.ThoiGianKetThuc?.ToString("yyyy-MM-ddTHH:mm") ?? "")">
                            </div>

                            <div class="col-12 d-flex align-items-center mt-2">
                                <input class="form-check-input me-2" type="checkbox" id="tronCauHoi" @(Model?.TronCauHoi == true ? "checked" : "")>
                                <label class="form-check-label fw-semibold" for="tronCauHoi">
                                    Đảo câu hỏi
                                </label>
                            </div>

                            <div class="col-12 d-flex align-items-center mt-2">
                                <input class="form-check-input me-2" type="checkbox" id="choXemKetQua" @(Model?.ChoXemKetQua == true ? "checked" : "")>
                                <label class="form-check-label fw-semibold" for="choXemKetQua">
                                    Cho xem kết quả khi thi xong
                                </label>
                            </div>

                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger rounded-3" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-success rounded-3" onclick="saveSettings()">Lưu cài đặt</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Sửa - Giao bài -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content rounded-4 shadow">

                    <!-- Header -->
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="editModalLabel">Chỉnh sửa giao bài</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>

                    <!-- Body -->
                    <div class="modal-body">

                        <div class="col-12">
                            <label class="form-label d-flex justify-content-between align-items-center mb-2">
                                <span>Giao cho</span>
                            </label>

                            <!-- HEADER -->
                            <div class="student-header mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <!-- Search -->
                                    <div class="input-group w-50">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="search" class="form-control form-control-sm" id="searchStudent"
                                               placeholder="Tìm theo tên học sinh..." onkeyup="filterStudents()">
                                    </div>

                                    <!-- Check all -->
                                    <div class="form-check ms-2">
                                        <input class="form-check-input" type="checkbox" id="checkAllStudents" onchange="toggleAllStudents()">
                                        <label class="form-check-label small" for="checkAllStudents">
                                            Chọn tất cả     
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Danh sách có thể cuộn -->
                            <div class="student-list-container border rounded-3 p-2" id="studentList" style="max-height: 300px; overflow-y: auto;">
                                <!-- Sẽ được load từ JavaScript -->
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-inbox"></i> Đang tải danh sách sinh viên...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary" onclick="saveGiaoBai()">Lưu thay đổi</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal Xem chi tiết câu hỏi -->
        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content rounded-4 shadow">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Chi tiết bài trắc nghiệm (@soCauHoi câu)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>

                    <div class="modal-body bg-white" style="max-height: 75vh; overflow-y: auto;">
                        @if (Model?.CauHois != null && Model.CauHois.Any())
                        {
                            int cauSo = 1;
                            foreach (var cauHoi in Model.CauHois.OrderBy(c => c.ThuTu ?? c.CauHoiId))
                            {
                                <div class="mb-4">
                                    <div class="fw-bold">
                                        Câu @cauSo 
                                    </div>
                                    <div class="fw-semibold mt-1 mb-2">@cauHoi.NoiDungCauHoi</div>
                                    
                                    <!-- ⭐ THÊM HIỂN THỊ HÌNH ẢNH ⭐ -->
                                    @if (!string.IsNullOrEmpty(cauHoi.HinhAnh))
                                    {
                                        var imagePath = cauHoi.HinhAnh.StartsWith("/") ? cauHoi.HinhAnh : "/" + cauHoi.HinhAnh;
                                        <div class="text-center my-3">
                                            <img src="@imagePath" 
                                                 alt="Hình ảnh câu @cauSo" 
                                                 class="img-fluid rounded border shadow-sm"
                                                 style="max-width: 100%; max-height: 400px; object-fit: contain;"
                                                 onerror="this.style.display='none'; console.error('Failed to load: @imagePath');">
                                        </div>
                                    }
                                    
                                    @if (cauHoi.DapAns != null && cauHoi.DapAns.Any())
                                    {
                                        char dapAnChar = 'A';
                                        foreach (var dapAn in cauHoi.DapAns.OrderBy(d => d.ThuTu ?? d.DapAnId))
                                        {
                                            var isDung = dapAn.LaDapAnDung == true;
                                            <div class="@(isDung ? "text-success fw-semibold" : "")">
                                                @dapAnChar. @dapAn.NoiDungDapAn @(isDung ? "(Đáp án đúng)" : "")
                                            </div>
                                            dapAnChar++;
                                        }
                                        
                                        var dapAnDung = cauHoi.DapAns.FirstOrDefault(d => d.LaDapAnDung == true);
                                        if (dapAnDung != null)
                                        {
                                            var danhSachDapAn = cauHoi.DapAns.OrderBy(d => d.ThuTu ?? d.DapAnId).ToList();
                                            var viTri = danhSachDapAn.IndexOf(dapAnDung);
                                            <div class="text-success mt-2 fw-semibold">
                                                Đáp án: @((char)('A' + viTri))
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-danger small">Chưa có đáp án</div>
                                    }
                                    <hr>
                                </div>
                                cauSo++;
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                Chưa có câu hỏi nào
                            </div>
                        }
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ⭐ LOAD FILE JS RIÊNG ⭐ -->
<script src="~/assets/js/teacher/JS_QuanLyTracNghiem.js"></script>

<!-- ⭐ KHỞI TẠO VỚI DỮ LIỆU TỪ MODEL ⭐ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const baiTracNghiemId = @(Model?.BaiTracNghiemId ?? 0);
        const khoaHocId = @(Model?.KhoaHocId ?? 0);
        
        // ⭐ KHỞI TẠO - GỌI FUNCTION initTaoBaiTracNghiem ⭐
        if (typeof initTaoBaiTracNghiem === 'function') {
            initTaoBaiTracNghiem(baiTracNghiemId, khoaHocId);
        }

        // ⭐ LOAD DANH SÁCH SINH VIÊN KHI MỞ MODAL GIAO BÀI ⭐
        const editModal = document.getElementById('editModal');
        if (editModal) {
            editModal.addEventListener('shown.bs.modal', function () {
                console.log('Edit modal opened, loading student list...');
                if (typeof loadDanhSachSinhVien === 'function') {
                    loadDanhSachSinhVien();
                }
            });
        }

        // ⭐ EVENT LISTENER CHO CHECKBOXES ĐỂ CẬP NHẬT "CHỌN TẤT CẢ" ⭐
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('student-checkbox')) {
                const checkAllBox = document.getElementById('checkAllStudents');
                const checkboxes = document.querySelectorAll('.student-checkbox');
                const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
                
                if (checkedCount === 0) {
                    checkAllBox.checked = false;
                    checkAllBox.indeterminate = false;
                } else if (checkedCount === checkboxes.length) {
                    checkAllBox.checked = true;
                    checkAllBox.indeterminate = false;
                } else {
                    checkAllBox.checked = false;
                    checkAllBox.indeterminate = true;
                }
            }
        });
    });
</script>

<!-- ⭐ CSS BỔ SUNG ⭐ -->
<style>
    .hover-bg-light:hover {
        background-color: #f8f9fa !important;
        transition: background-color 0.2s ease;
    }
    
    .student-item {
        transition: all 0.2s ease;
    }
    
    .student-item:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* Style cho checkbox indeterminate */
    input[type="checkbox"]:indeterminate {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
</style>
