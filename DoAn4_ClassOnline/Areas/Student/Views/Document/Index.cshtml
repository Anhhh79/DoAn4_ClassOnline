@{
    var taiLieus = ViewBag.TaiLieus as List<DoAn4_ClassOnline.Models.TaiLieu> ?? new List<DoAn4_ClassOnline.Models.TaiLieu>();
    var khoaHocId = ViewBag.KhoaHocId ?? 0;
    var errorMessage = ViewBag.ErrorMessage as string;
}

<div class="row g-3 mt-4 p-3 shadow rounded-4 bg-white">
    <h5 class="fw-bold mb-3">
        <i class="bi bi-file-earmark-text me-2 text-primary"></i> Tài liệu học tập
    </h5>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-triangle me-2"></i>
                @errorMessage
            </div>
        </div>
    }
    else if (taiLieus.Any())
    {
        @for (int i = 0; i < taiLieus.Count; i++)
        {
            var taiLieu = taiLieus[i];
            var collapseId = "collapseTaiLieu" + taiLieu.TaiLieuId;

            <div class="col-12">
                <div class="border rounded-3 p-3 mb-2 bg-body-tertiary">
                    <a class="text-decoration-none text-dark d-flex justify-content-between align-items-center"
                       data-bs-toggle="collapse" href="#@collapseId" role="button" aria-expanded="false" aria-controls="@collapseId">

                        <div class="d-flex flex-column flex-md-row justify-content-between w-100">
                            <div>
                                <strong>Tài liệu @(i + 1):</strong> @taiLieu.TenTaiLieu
                            </div>
                            <div class="text-muted small ms-md-3 mt-2 mt-md-0">
                                <span class="text-muted">
                                    <i class="bi bi-clock me-1"></i> @(taiLieu.NgayTao?.ToString("dd/MM/yyyy - HH:mm") ?? "N/A")
                                </span>
                            </div>
                        </div>

                        <i class="bi bi-chevron-down ms-2"></i>
                    </a>
                </div>

                <div class="collapse" id="@collapseId">
                    <div class="p-3 border rounded-3 mb-3" style="background-color: rgba(243, 246, 248);">
                        <p>
                            @if (!string.IsNullOrEmpty(taiLieu.MoTa))
                            {
                                @Html.Raw(taiLieu.MoTa)
                            }
                            else
                            {
                                <text>Không có mô tả cho tài liệu này.</text>
                            }
                        </p>

                        <hr>

                        @if (taiLieu.TaiLieuFiles.Any())
                        {
                            <!-- Danh sách tài liệu -->
                            <div class="row gy-2">
                                @foreach (var file in taiLieu.TaiLieuFiles)
                                {
                                    var fileExtension = file.LoaiFile?.ToLower() ?? "";
                                    var iconClass = "";
                                    var colorClass = "";
                                    var btnClass = "";
                                    var fileType = "File";

                                    if (fileExtension.Contains("doc") || fileExtension == ".docx")
                                    {
                                        iconClass = "bi-file-earmark-word";
                                        colorClass = "color: blue;";
                                        btnClass = "btn-outline-primary";
                                        fileType = "Word";
                                    }
                                    else if (fileExtension.Contains("xls") || fileExtension == ".xlsx")
                                    {
                                        iconClass = "bi-file-earmark-excel";
                                        colorClass = "color: green;";
                                        btnClass = "btn-outline-success";
                                        fileType = "Excel";
                                    }
                                    else if (fileExtension.Contains("pdf") || fileExtension == ".pdf")
                                    {
                                        iconClass = "bi-file-earmark-pdf";
                                        colorClass = "color: red;";
                                        btnClass = "btn-outline-danger";
                                        fileType = "PDF";
                                    }
                                    else if (fileExtension.Contains("ppt") || fileExtension == ".pptx")
                                    {
                                        iconClass = "bi-file-earmark-ppt";
                                        colorClass = "color: orange;";
                                        btnClass = "btn-outline-warning";
                                        fileType = "PowerPoint";
                                    }
                                    else
                                    {
                                        iconClass = "bi-file-earmark";
                                        colorClass = "color: gray;";
                                        btnClass = "btn-outline-secondary";
                                        fileType = "File";
                                    }

                                    <div class="col-12">
                                        <a href="@file.DuongDan" download
                                           class="d-flex justify-content-between align-items-center text-decoration-none border rounded-3 p-3 bg-white shadow-sm hover-shadow-sm" style="@colorClass">
                                            <div class="d-flex align-items-center">
                                                <i class="bi @iconClass fs-4 me-3"></i>
                                                <div>
                                                    <strong>Tài liệu @fileType:</strong> @file.TenFile
                                                    @if (file.KichThuoc.HasValue)
                                                    {
                                                        var kichThuocMB = (file.KichThuoc.Value / 1024.0 / 1024.0).ToString("0.##");
                                                        <small class="text-muted d-block">Kích thước: @kichThuocMB MB</small>
                                                    }
                                                </div>
                                            </div>
                                            <button class="btn btn-sm @btnClass">
                                                <i class="bi bi-download me-1"></i> Tải xuống
                                            </button>
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center">
                                <i class="bi bi-inbox me-2"></i>
                                Không có file đính kèm.
                            </p>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle me-2"></i>
                Chưa có tài liệu nào được đăng tải trong khóa học này.
            </div>
        </div>
    }
</div>
